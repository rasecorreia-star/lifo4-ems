global:
  smtp_from: 'alertas@lifo4.com.br'
  smtp_smarthost: '${SMTP_HOST:-smtp.gmail.com}:587'
  smtp_auth_username: '${SMTP_USER}'
  smtp_auth_password: '${SMTP_PASSWORD}'
  smtp_require_tls: true

templates:
  - '/etc/alertmanager/templates/*.tmpl'

route:
  group_by: ['alertname', 'system_id']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h
  receiver: 'default'
  routes:
    # P1 Critical — immediate multi-channel
    - match:
        priority: P1
      receiver: critical-receiver
      group_wait: 0s
      repeat_interval: 15m

    # P2 High — 15 min delay
    - match:
        priority: P2
      receiver: high-receiver
      group_wait: 15m
      repeat_interval: 1h

    # P3 Medium — ticket only
    - match:
        priority: P3
      receiver: medium-receiver
      group_wait: 30m
      repeat_interval: 4h

    # P4 Low — dashboard only (no notifications)
    - match:
        priority: P4
      receiver: null-receiver

receivers:
  - name: 'default'
    email_configs:
      - to: 'operacoes@lifo4.com.br'
        subject: '[EMS] Alerta: {{ .GroupLabels.alertname }}'
        body: '{{ range .Alerts }}Sistema: {{ .Labels.system_id }}\nDescricao: {{ .Annotations.description }}\n{{ end }}'

  - name: 'critical-receiver'
    email_configs:
      - to: 'plantao@lifo4.com.br,diretoria@lifo4.com.br'
        subject: '[CRITICO] {{ .GroupLabels.alertname }} — EMS BESS'
        body: '{{ range .Alerts }}Sistema: {{ .Labels.system_id }}\nResumo: {{ .Annotations.summary }}\nDescricao: {{ .Annotations.description }}\nRunbook: {{ .Annotations.runbook }}\n{{ end }}'
    webhook_configs:
      - url: '${WEBHOOK_CRITICAL_URL:-http://backend:3001/api/v1/alerts/webhook}'
        send_resolved: true

  - name: 'high-receiver'
    email_configs:
      - to: 'tecnicos@lifo4.com.br'
        subject: '[ALTO] {{ .GroupLabels.alertname }} — EMS BESS'
        body: '{{ range .Alerts }}Sistema: {{ .Labels.system_id }}\nResumo: {{ .Annotations.summary }}\nDescricao: {{ .Annotations.description }}\n{{ end }}'

  - name: 'medium-receiver'
    webhook_configs:
      - url: '${WEBHOOK_TICKET_URL:-http://backend:3001/api/v1/alerts/ticket}'
        send_resolved: false

  - name: 'null-receiver'

inhibit_rules:
  # Suppress lower-priority alerts when critical alert is firing
  - source_match:
      severity: critical
    target_match_re:
      severity: 'high|medium|low'
    equal: ['system_id']
